<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <title>Circles</title>
    <style>
      /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */
      #map {
        height: 100%;
      }
      /* Optional: Makes the sample page fill the window. */
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <script>
      // This example creates circles on the map, representing populations in North
      // America.
      let circleSet = new Set();
      var audio = new Audio('ping3.wav');
      var homicideAudio = new Audio('homicide.mp3');
      var robberyAudio = new Audio('robbery.mp3')
      // First, create an object containing LatLng and population for each crime.
      var crimemap = {};

      // var crimeList = [{"larcency": {lat: 37.869363, lng: -122.268028}},  
      //                  {"assault": {lat: 37.869685, lng: -122.272804}},
      //                  {"domesticviolence": {lat: 37.869482, lng: -122.243}},
      //                  {"vehiclestolen": {lat: 37.864703, lng: -122.299654}}];

      function setIntervalLimited(callback, interval, x) {
        for (var i = 0; i < x; i++) {
          setTimeout(callback, i * interval);
        }
      }

      function httpGet(theUrl, callBack, id) {
         function callBack(result) {
            result.sort(function(a, b){
            var keyA = new Date(a.eventdt),
                keyB = new Date(b.eventdt);
            // Compare the 2 dates
            if(keyA < keyB) return 1;
            if(keyA > keyB) return -1;
            return 0;
            });
          for (var i=0; i<20; i++) {
            crime = result[i];
            var title = crime.offense + " " + crime.caseno;
            crimemap[title] = {center: {lat: crime.block_location.coordinates[1], lng: crime.block_location.coordinates[0]}};
            }
          }


          var xmlHttp = new XMLHttpRequest();
          xmlHttp.open( "GET", theUrl, true ); // false for synchronous request
          xmlHttp.onreadystatechange = function() {
          if (this.responseText && this.status == 200) {
              callBack(JSON.parse(this.responseText));
            }
          }
          xmlHttp.send( null );
      }

      function initMap() {
        // Create the map.
        var map = new google.maps.Map(document.getElementById('map'), {
          center: {lat: 37.8716, lng: -122.2590},
          zoom: 15,
          styles: [
            {elementType: 'geometry', stylers: [{color: '#242f3e'}]},
            {elementType: 'labels.text.stroke', stylers: [{color: '#242f3e'}]},
            {elementType: 'labels.text.fill', stylers: [{color: '#4C814B'}]},
            {
              featureType: 'administrative.locality',
              elementType: 'labels.text.fill',
              stylers: [{color: '#4BFF48'}]
            },
            {
              featureType: 'poi',
              elementType: 'labels.text.fill',
              stylers: [{color: '#43B441'}]
            },
            {
              featureType: 'poi.park',
              elementType: 'geometry',
              stylers: [{color: '#263c3f'}]
            },
            {
              featureType: 'poi.park',
              elementType: 'labels.text.fill',
              stylers: [{color: '#48AB46'}]
            },
            {
              featureType: 'road',
              elementType: 'geometry',
              stylers: [{color: '#38414e'}]
            },
            {
              featureType: 'road',
              elementType: 'geometry.stroke',
              stylers: [{color: '#212a37'}]
            },
            {
              featureType: 'road',
              elementType: 'labels.text.fill',
              stylers: [{color: '#9ca5b3'}]
            },
            {
              featureType: 'road.highway',
              elementType: 'geometry',
              stylers: [{color: '#3D653C'}]
            },
            {
              featureType: 'road.highway',
              elementType: 'geometry.stroke',
              stylers: [{color: '#1f2835'}]
            },
            {
              featureType: 'road.highway',
              elementType: 'labels.text.fill',
              stylers: [{color: '#6EA56D'}]
            },
            {
              featureType: 'transit',
              elementType: 'geometry',
              stylers: [{color: '#2f3948'}]
            },
            {
              featureType: 'transit.station',
              elementType: 'labels.text.fill',
              stylers: [{color: '#3D653C'}]
            },
            {
              featureType: 'water',
              elementType: 'geometry',
              stylers: [{color: '#17263c'}]
            },
            {
              featureType: 'water',
              elementType: 'labels.text.fill',
              stylers: [{color: '#3D653C'}]
            },
            {
              featureType: 'water',
              elementType: 'labels.text.stroke',
              stylers: [{color: '#17263c'}]
            },
            {
                featureType: 'transit.line',
                elementType: 'geometry',
                stylers: [{color: '#04C6FF'}, {lightness: -45}]
            },
          ]
        });
     
        //Â test circle
        setTimeout(function(){ 
          crimemap.MURDER = {center: {lat: 37.861363, lng: -122.268028}};
          console.log("hi");
          console.log(crimemap);
        }, 10000);
        // Will periodically check crimemap for new circles and add them;
        setInterval(function(){ spawnCircles(crimemap, map);}, 3000);
        // var transitLayer = new google.maps.TransitLayer();
        // transitLayer.setMap(map);
        // var trafficLayer = new google.maps.TrafficLayer();
        // trafficLayer.setMap(map)
        httpGet("https://data.cityofberkeley.info/resource/s24d-wsnp.json");
        setInterval(function(){ httpGet("https://data.cityofberkeley.info/resource/s24d-wsnp.json");}, 100000);
      }


    function spawnCircles(circlemap, map){
      for (var crime in crimemap) {
          // Add the circle for this crime to the map.
          if (!circleSet.has(crime)) {
            var type = crime.split(" ")[0];
            console.log(type);
            createCircle(crimemap[crime], map, type);

            circleSet.add(crime);
            audio.play();
          }
        }

        function createCircle(city, map, type) {
          var _radius = 50;
          var rMin = _radius * 4.95 / 5;
          var rMax = _radius;
          var direction = 1;
          if (type === 'MURDER') {
            homicideAudio.play();
            var color = "#FF0000";
          } else if (type === 'ROBBERY') {
            robberyAudio.play();
            var color = "#FFCA00";
          } else if (type === 'THEFT') {
            var color = "#F2FF00";
          } else {
            var color = "#00E1FF";
          }
          var circleOption = {
            center: city.center,
            fillColor: color,
            fillOpacity: 0.2,
            map: map,
            radius: 50,
            strokeColor: color,
            strokeOpacity: 1,
            strokeWeight: 0.5
          };
          var circle = new google.maps.Circle(circleOption);

          var pulseCount = 0;
          var circleTimer = setInterval(function() {
            if (pulseCount > 4) {
              clearInterval();
            }
            var radius = circle.getRadius();

            if ((radius > rMax) || (radius < rMin)) {
              direction *= -1;
            }
            var _par = (radius / _radius) - 0.4;

            circleOption.radius = radius + direction * 3;
            circleOption.fillOpacity = 0.6 * _par;

            circle.setOptions(circleOption);
            pulseCount += 1;
          }, 120, 500);
        }
    }

    </script>
    <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCKYDCHGyzBpajCH_DSt4GjnpFoLmsJf-k&callback=initMap">
    </script>
  </body>
</html>